- hosts: all
  become: false
  tasks:
  - name: "Check if {{ file_name }} on vshpere"
    vsphere_file:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: '{{ vm_validate_certs }}'
      datacenter: "{{ datacenter }}"
      datastore: "{{ datastore }}"
      path: "{{ folder_name}}/{{ file_name }}"
      state: touch
    delegate_to: localhost
    ignore_errors: yes
    register: ova_check

  - name:
    debug:
      var: ova_check

  - name: "Download {{ file_name }}"
    get_url:
      url: "{{ webserver_url }}/{{ file_name }}"
      dest: "/tmp/{{ file_name }}"
    when: ova_check.size == 0

  - name: "Get  {{ file_name }} sha information"
    stat:
      path: "/tmp/{{ file_name }}"
      checksum_algorithm: sha256
    register: file_name_sha
    when: ova_check.size == 0

  - name:
    debug:
      var: file_name_sha
    failed_when: file_sha != file_name_sha.stat.checksum
    when: ova_check.size == 0

  - name:
    debug:
      msg: "SHA256 matches"
    when: file_name_sha.stat.checksum == file_sha
    when: ova_check.size == 0

  - name: "Copy {{ file_name }} to  vcenter datastore"
    vsphere_copy:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: '{{ vm_validate_certs }}'
      src:  "/tmp/{{ file_name }}"
      datacenter: "{{ datacenter }}"
      datastore: "{{ datastore }}"
      path: "{{ folder_name}}/{{ file_name }}"
    delegate_to: localhost
    when: ova_check.size == 0
